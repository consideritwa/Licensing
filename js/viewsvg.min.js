function hasEdits(t){!Data.Edit.HasEdits&&t?(Data.Edit.HasEdits=!0,document.getElementById("menu-save").classList.add("active"),document.title+=" *"):Data.Edit.HasEdits&&!t&&(Data.Edit.HasEdits=!1,document.getElementById("menu-save").classList.remove("active"),document.title.endsWith(" *")&&(document.title=document.title.slice(0,-2)))}function getSvgXml(){return(new XMLSerializer).serializeToString(Data.Svg.Node)}function injectHighlightStyles(){const t=Data.Svg.Node.getElementById(STYLE_ID);t&&Data.Svg.Node.removeChild(t);const e="5px",a="2.5em",o="bold",i="Arial",n=document.createElement("style");n.id=STYLE_ID,n.textContent=`.${HIGH_CLASS_1}{fill:${Settings.Highlight1};}\n.${HIGH_CLASS_2}{fill:${Settings.Highlight2};}\n.${HIGH_CLASS_3}{fill:${Settings.Highlight3};}\n.${HIGH_CLASS_4}{fill:${Settings.Highlight4};}\n.${DRAW_CLASS}{stroke-width:${e};stroke-linecap:round;stroke-linejoin:round;fill-opacity:25%;stroke-opacity:80%;}\n.${TEXT_CLASS}{font-family:${i};font-size:${a};font-weight:${o};}\n.${SELECT_CLASS}{filter:drop-shadow(0 0 10px #ff0);}`,Data.Svg.Node.appendChild(n)}function findHighlightTarget(t){let e=t;for(;"tspan"===e.nodeName;)e=e.parentNode;if("text"===e.nodeName&&(e=e.parentNode),"g"===e.nodeName||"a"===e.nodeName){let t=e.getElementsByTagName("rect");if(0===t.length&&(t=e.getElementsByTagName("path")),0===t.length)return;e=t.item(0)}return"rect"===e.nodeName||"path"===e.nodeName||"circle"===e.nodeName||"ellipse"===e.nodeName?e:void 0}function resizeSvg(){let t=1;switch(Settings.Zoom){case"Fit":t=Math.min(window.innerWidth/Data.Svg.NativeWidth,window.innerHeight/Data.Svg.NativeHeight);break;case"Fit Width":t=window.innerWidth/Data.Svg.NativeWidth;break;case"Fit Height":t=window.innerHeight/Data.Svg.NativeHeight;break;case"Fill":t=Math.max(window.innerWidth/Data.Svg.NativeWidth,window.innerHeight/Data.Svg.NativeHeight);break;case"Original":break;default:throw"Unexpected Zoom setting: "+Settings.Zoom}Data.Svg.StartWidth=Data.Svg.NativeWidth*t,Data.Svg.StartHeight=Data.Svg.NativeHeight*t,Data.Svg.Node.style.width=Data.Svg.StartWidth.toFixed(0)+"px",Data.Svg.Node.style.height=Data.Svg.StartHeight.toFixed(0)+"px",Data.Zoom.Level=100;const e=window.innerWidth/2-Data.Svg.StartWidth/2,a=window.innerHeight/2-Data.Svg.StartHeight/2;Data.Svg.Node.style.left=e.toFixed(0)+"px",Data.Svg.Node.style.top=a.toFixed(0)+"px",Data.Svg.RatioX=Data.Svg.StartWidth/Data.Svg.NativeWidth,Data.Svg.RatioY=Data.Svg.StartHeight/Data.Svg.NativeHeight}function resetSvgPosition(){const t=parseFloat(Data.Svg.Node.style.width),e=window.innerWidth/2-t/2;Data.Svg.Node.style.left=e.toFixed(0)+"px";const a=parseFloat(Data.Svg.Node.style.height),o=window.innerHeight/2-a/2;Data.Svg.Node.style.top=o.toFixed(0)+"px"}function applyHighlightOnClick(t){if(!Data.Edit.Node)return;let e=HIGH_CLASS_1;t.shiftKey&&t.ctrlKey?e=HIGH_CLASS_4:t.ctrlKey?e=HIGH_CLASS_3:t.shiftKey&&(e=HIGH_CLASS_2),Data.Edit.Node.classList.contains(e)?Data.Edit.Node.classList.remove(e):(Data.Edit.Node.classList.remove(HIGH_CLASS_1),Data.Edit.Node.classList.remove(HIGH_CLASS_2),Data.Edit.Node.classList.remove(HIGH_CLASS_3),Data.Edit.Node.classList.remove(HIGH_CLASS_4),Data.Edit.Node.classList.add(e)),hasEdits(!0)}function setNodeTooltip(){if(!Data.Edit.Node)return;let t=Data.Edit.Node;for(;"svg"!==t.parentNode.tagName;)t=t.parentNode;let e=void 0,a=t.getElementsByTagName("title");a.length>=1&&(e=a.item(0)),showModalDialog(e?"Update or delete item notes":"Set item notes",!0,e?e.textContent:"","OK",function(){let a=getModalInputText();a&&(a=a.trim()),a&&(e?e.textContent=a:(e=document.createElementNS(SVG_NAMESPACE,"title"),e.textContent=a,t.appendChild(e)),hasEdits(!0)),Data.Edit.Node.classList.remove(SELECT_CLASS)},e?"Delete":void 0,function(){e.remove(),Data.Edit.Node.classList.remove(SELECT_CLASS)},"Cancel",function(){Data.Edit.Node.classList.remove(SELECT_CLASS)})}function setNodeHyperlink(){if(!Data.Edit.Node)return;let t=void 0;for(let e=Data.Edit.Node;e&&e!=Data.Svg.Node&&e!=document;e=e.parentNode)if("a"===e.tagName){t=e;break}if(!(t||Data.Edit.Node.classList.contains(TEXT_CLASS)||Data.Edit.Node.classList.contains(IMAGE_CLASS)||Data.Edit.Node.classList.contains(DRAW_CLASS)))return void Data.Edit.Node.classList.remove(SELECT_CLASS);const e=t?t.getAttribute("href"):void 0;showModalDialog(t&&e?"Update or delete item hyperlink":"Set item hyperlink",!0,e||"https://","OK",function(){let e=getModalInputText();if(e&&(e=e.trim()),e){if(t)t.setAttribute("href",e);else{t=document.createElementNS(SVG_NAMESPACE,"a"),t.setAttribute("target","_blank"),t.setAttribute("href",e);const a=Data.Edit.Node.parentNode;a.insertBefore(t,Data.Edit.Node),a.removeChild(Data.Edit.Node),t.appendChild(Data.Edit.Node)}hasEdits(!0)}Data.Edit.Node.classList.remove(SELECT_CLASS)},t&&e?"Delete":void 0,function(){t.removeAttribute("href"),Data.Edit.Node.classList.remove(SELECT_CLASS)},"Cancel",function(){Data.Edit.Node.classList.remove(SELECT_CLASS)})}function insertImage(t,e,a){const o=new Image;e&&(o.width=e),a&&(o.height=a),o.onload=function(){const t=(Data.Pointer.X-parseFloat(Data.Svg.Node.style.left))/Data.Svg.RatioX,e=(Data.Pointer.Y-parseFloat(Data.Svg.Node.style.top))/Data.Svg.RatioY;let a=o.width,i=o.height;console.log("Image Loaded (w,h):",a,i),(a>Data.Svg.NativeWidth||i>Data.Svg.NativeHeight)&&(scale=.9*Math.min(Data.Svg.NativeWidth/a,Data.Svg.NativeHeight/i),a*=scale,i*=scale);const n=document.createElementNS(SVG_NAMESPACE,"image");n.setAttribute("href",o.src),n.setAttribute("width",a.toFixed(1)),n.setAttribute("height",i.toFixed(1)),n.setAttribute("x",0),n.setAttribute("y",0),n.setAttribute("class",IMAGE_CLASS),n.setAttribute("transform",`translate(${t.toFixed(1)} ${e.toFixed(1)})`),n.setAttribute("data-width",o.width),n.setAttribute("data-height",o.height),Data.Svg.Node.appendChild(n),hasEdits(!0)},o.src=t}function fileSelectorUploadEvent(t){if(0===t.target.files.length)return;const e=new FileReader;e.onload=function(t){insertImage(t.target.result)};const a=t.target.files[0];e.readAsDataURL(a)}function imageListItemCallback(t){const e=new RegExp("(.*)\\(([0-9]+)x([0-9]+)\\)"),a=e.exec(t.target.value);a&&4===a.length?insertImage(a[1],a[2],a[3]):insertImage(t.target.value)}function addImageOnClick(){showModalDialog("Select or upload an image",!1,void 0,"Upload",function(){document.getElementById("file-selector").click()},void 0,void 0,"Cancel",void 0,!0,IMAGE_GALLERY,imageListItemCallback)}function addOrUpdateTextLabel(){showModalDialog(Data.Edit.Node?"Update or delete text label":"Add a text label",!0,Data.Edit.Node?Data.Edit.Node.textContent:"","OK",function(){let t=getModalInputText();if(t&&(t=t.trim()),t){if(Data.Edit.Node){Data.Edit.Node.textContent=t;const e=getModalColourValue();e&&(Data.Edit.Node.style.fill=e),Data.Edit.Node.classList.remove(SELECT_CLASS)}else{const e=(Data.Pointer.X-parseFloat(Data.Svg.Node.style.left))/Data.Svg.RatioX,a=(Data.Pointer.Y-parseFloat(Data.Svg.Node.style.top))/Data.Svg.RatioY,o=document.createElementNS(SVG_NAMESPACE,"text");o.setAttribute("class",TEXT_CLASS),o.setAttribute("transform",`translate(${e.toFixed(1)} ${a.toFixed(1)})`),o.textContent=t;const i=getModalColourValue();o.style.fill=i||Colours[0],Data.Svg.Node.appendChild(o)}hasEdits(!0)}},Data.Edit.Node?"Delete":void 0,function(){Data.Edit.Node.remove(),hasEdits(!0)},"Cancel",function(){Data.Edit.Node&&Data.Edit.Node.classList.remove(SELECT_CLASS)},!1,void 0,void 0,!0,"Select a label colour:",Data.Edit.Node?getHexForColour(Data.Edit.Node.style.fill):"#ff0000")}function cycleColour(t){let e=Colours.findIndex(e=>e.toUpperCase()===t.toUpperCase());return-1===e&&(e=0),e=(e+1)%Colours.length,Colours[e]}function cycleDrawColour(){Data.Edit.Node.style.stroke=cycleColour(Data.Edit.Node.style.stroke),hasEdits(!0)}function auxClickEvent(t){if(t.button===Mouse.Button.Right&&!Data.IgnoreClick){switch(Data.Edit.Node&&Data.Edit.Node.classList.remove(SELECT_CLASS),Data.Edit.Mode){case EditModes.Draw:t.target.classList.contains(DRAW_CLASS)&&(t.target.remove(),hasEdits(!0));break;case EditModes.Highlight:removeHighlights(t.target);break;case EditModes.Text:t.target.classList.contains(TEXT_CLASS)&&(t.target.remove(),hasEdits(!0));break;case EditModes.Image:t.target.classList.contains(IMAGE_CLASS)&&(t.target.remove(),hasEdits(!0));break;case EditModes.Link:case EditModes.Notes:default:resizeSvg()}t.preventDefault()}}function clickSvgEvent(t){if(Data.IgnoreClick)t.preventDefault();else switch(Data.Edit.Mode){case EditModes.Highlight:applyHighlightOnClick(t),Data.Edit.Node&&Data.Edit.Node.classList.remove(SELECT_CLASS),t.preventDefault();break;case EditModes.Draw:Data.Edit.Node&&(cycleDrawColour(),Data.Edit.Node.classList.remove(SELECT_CLASS)),t.preventDefault();break;case EditModes.Text:Data.Edit.Node?t.ctrlKey?(resetScaleTransform(),Data.Edit.Node.classList.remove(SELECT_CLASS)):t.shiftKey?(stepRotationTransform(),Data.Edit.Node.classList.remove(SELECT_CLASS)):addOrUpdateTextLabel():addOrUpdateTextLabel(),t.preventDefault();break;case EditModes.Image:Data.Edit.Node?(Data.Edit.Node.classList.remove(SELECT_CLASS),t.ctrlKey?resetScaleTransform():t.shiftKey?stepRotationTransform():addImageOnClick()):addImageOnClick(),t.preventDefault();break;case EditModes.Link:setNodeHyperlink(),t.preventDefault();break;case EditModes.Notes:setNodeTooltip(),t.preventDefault();break;default:Data.Edit.Node&&Data.Edit.Node.classList.remove(SELECT_CLASS)}}function isDescendantOf(t,e){const a=e.toUpperCase();for(let e=t;e&&e!=document;e=e.parentNode)if(e.tagName.toUpperCase()===a)return!0;return!1}function updateTransform(){const t=[];0===Data.Edit.Transform.Translate.X&&0===Data.Edit.Transform.Translate.Y||t.push(`translate(${Data.Edit.Transform.Translate.X.toFixed(1)} ${Data.Edit.Transform.Translate.Y.toFixed(1)})`),0!==Data.Edit.Transform.Rotate&&t.push(`rotate(${Data.Edit.Transform.Rotate.toFixed(1)})`),1!==Data.Edit.Transform.Scale&&t.push(`scale(${Data.Edit.Transform.Scale.toFixed(2)})`),Data.Edit.Node.setAttribute("transform",t.join(" "))}function parseTransform(t){Data.Edit.Transform.Translate.X=0,Data.Edit.Transform.Translate.Y=0,Data.Edit.Transform.Rotate=0,Data.Edit.Transform.Scale=1;const e=t.getAttribute("transform");if(!e)return;const a=e.split(/\(|\s|\)/);for(let t=0;t<a.length;t++)switch(a[t]){case"translate":Data.Edit.Transform.Translate.X=parseFloat(a[++t]),Data.Edit.Transform.Translate.Y=parseFloat(a[++t]);break;case"rotate":Data.Edit.Transform.Rotate=parseFloat(a[++t]);break;case"scale":Data.Edit.Transform.Scale=parseFloat(a[++t])}}function pointerDown(t,e,a,o,i){if(t===document.body||isDescendantOf(t,"svg"))switch(Data.Pointer.IgnoreMove=!1,Data.Pointer.Moved=!1,Data.Pointer.X=e,Data.Pointer.Y=a,Data.Scroll.StartLeft=parseFloat(Data.Svg.Node.style.left),Data.Scroll.StartTop=parseFloat(Data.Svg.Node.style.top),Data.Edit.Node=void 0,Data.Action.Type=void 0,Data.Edit.Mode){case EditModes.Highlight:Data.Edit.Node=findHighlightTarget(t),Data.Edit.Node&&Data.Edit.Node.classList.add(SELECT_CLASS);break;case EditModes.Draw:t.classList.contains(DRAW_CLASS)?(Data.Edit.Node=t,Data.Edit.Node.classList.add(SELECT_CLASS),parseTransform(t),Data.Action.Type=Actions.Move,Data.Pointer.X-=Data.Edit.Transform.Translate.X*Data.Svg.RatioX,Data.Pointer.Y-=Data.Edit.Transform.Translate.Y*Data.Svg.RatioY):(Data.IgnoreClick=!0,Data.Action.Type=Actions.Add);break;case EditModes.Text:t.classList.contains(TEXT_CLASS)&&(Data.Edit.Node=t,Data.Edit.Node.classList.add(SELECT_CLASS),parseTransform(t),o?Data.Action.Type=Actions.Resize:i?Data.Action.Type=Actions.Rotate:(Data.Action.Type=Actions.Move,Data.Pointer.X-=Data.Edit.Transform.Translate.X*Data.Svg.RatioX,Data.Pointer.Y-=Data.Edit.Transform.Translate.Y*Data.Svg.RatioY));break;case EditModes.Image:t.classList.contains(IMAGE_CLASS)&&(Data.Edit.Node=t,Data.Edit.Node.classList.add(SELECT_CLASS),parseTransform(t),o?Data.Action.Type=Actions.Resize:i?Data.Action.Type=Actions.Rotate:(Data.Action.Type=Actions.Move,Data.Pointer.X-=Data.Edit.Transform.Translate.X*Data.Svg.RatioX,Data.Pointer.Y-=Data.Edit.Transform.Translate.Y*Data.Svg.RatioY));break;case EditModes.Link:case EditModes.Notes:Data.Edit.Node=t,(t.classList.contains(IMAGE_CLASS)||t.classList.contains(TEXT_CLASS)||t.classList.contains(DRAW_CLASS))&&t.classList.add(SELECT_CLASS)}}function mouseDown(t){Data.IgnoreClick=!1,t.buttons===Mouse.Buttons.Left?(Data.Pointer.IgnoreMove=!0,pointerDown(t.target,t.clientX,t.clientY,t.ctrlKey,t.shiftKey)):t.buttons===Mouse.Buttons.Right&&(Data.Pointer.IgnoreMove=!1)}function drawModePaint(t,e,a,o){if(Math.abs(t-Data.Pointer.X)+Math.abs(e-Data.Pointer.Y)<4)return;Data.Action.Active||(document.body.classList.add("drawing"),Data.Action.Active=!0,Data.IgnoreClick=!0,hasEdits(!0));const i=parseFloat(Data.Svg.Node.style.left),n=parseFloat(Data.Svg.Node.style.top);if(!Data.Edit.Node){const t=(Data.Pointer.X-i)/Data.Svg.RatioX,e=(Data.Pointer.Y-n)/Data.Svg.RatioY,a=document.createElementNS(SVG_NAMESPACE,"path");a.setAttribute("class",DRAW_CLASS),a.setAttribute("d",`M${t.toFixed(1)} ${e.toFixed(1)}`),a.style.stroke=Colours[0],Data.Svg.Node.appendChild(a),Data.Edit.Node=a}const s=(t-i)/Data.Svg.RatioX,d=(e-n)/Data.Svg.RatioY;if(a){const t=Data.Edit.Node.attributes.d.value.lastIndexOf("L");-1!==t&&(Data.Edit.Node.attributes.d.value=Data.Edit.Node.attributes.d.value.slice(0,t))}Data.Edit.Node.attributes.d.value.endsWith("Z")&&(Data.Edit.Node.attributes.d.value=Data.Edit.Node.attributes.d.value.slice(0,-1)),Data.Edit.Node.attributes.d.value+=`L${s.toFixed(1)} ${d.toFixed(1)}`,o&&(Data.Edit.Node.attributes.d.value+="Z"),Data.Pointer.X=t,Data.Pointer.Y=e}function scrollMove(t,e){Data.Action.Active||(document.body.classList.add("scrolling"),Data.Action.Type=Actions.Scroll,Data.Action.Active=!0,Data.IgnoreClick=!0);const a=(Data.Scroll.StartLeft-Data.Pointer.X+t).toFixed(0);Data.Svg.Node.style.left=a+"px";const o=(Data.Scroll.StartTop-Data.Pointer.Y+e).toFixed(0);Data.Svg.Node.style.top=o+"px",Data.Edit.Node&&Data.Edit.Node.classList.remove(SELECT_CLASS)}function moveNodeByTransform(t,e){Data.Action.Active||(document.body.classList.add("moving"),Data.Action.Type=Actions.Move,Data.Action.Active=!0,Data.IgnoreClick=!0,hasEdits(!0)),Data.Edit.Transform.Translate.X=(t-Data.Pointer.X)/Data.Svg.RatioX,Data.Edit.Transform.Translate.Y=(e-Data.Pointer.Y)/Data.Svg.RatioY,updateTransform()}function rotateNodeByTransform(t,e){Data.Action.Active||(document.body.classList.add("rotating"),Data.Action.Type=Actions.Rotate,Data.Action.Active=!0,Data.IgnoreClick=!0,hasEdits(!0));const a=(t-parseFloat(Data.Svg.Node.style.left))/Data.Svg.RatioX-Data.Edit.Transform.Translate.X,o=(e-parseFloat(Data.Svg.Node.style.top))/Data.Svg.RatioY-Data.Edit.Transform.Translate.Y;Data.Edit.Transform.Rotate=180*Math.atan(o/a)/Math.PI,a<0&&(Data.Edit.Transform.Rotate+=180),updateTransform()}function resizeNodeByTransform(t){Data.Action.Active||(document.body.classList.add("resizing"),Data.Action.Type=Actions.Resize,Data.Action.Active=!0,Data.IgnoreClick=!0,Data.Edit.Transform.StartScale=Data.Edit.Transform.Scale,hasEdits(!0));const e=Data.Pointer.Y,a=-window.innerHeight-Data.Pointer.Y,o=(10-Data.Edit.Transform.StartScale)/e,i=(.05-Data.Edit.Transform.StartScale)/a;let n=Data.Pointer.Y-t;n>e&&(n=e),n<a&&(n=a),Data.Edit.Transform.Scale=Data.Edit.Transform.StartScale+n*(n>0?o:i),updateTransform()}function resetScaleTransform(){Data.Edit.Transform.Scale=1,updateTransform()}function stepRotationTransform(t=90){const e=(Data.Edit.Transform.Rotate+t)%360,a=Math.floor(e/t);Data.Edit.Transform.Rotate=a*t,updateTransform()}function pointerMove(t,e,a,o){switch(Data.Edit.Mode){case EditModes.Off:case EditModes.Highlight:scrollMove(t,e);break;case EditModes.Draw:switch(Data.Action.Type){case Actions.Add:drawModePaint(t,e,a,o);break;case Actions.Move:moveNodeByTransform(t,e)}break;case EditModes.Text:case EditModes.Image:switch(Data.Action.Type){case Actions.Move:moveNodeByTransform(t,e);break;case Actions.Rotate:rotateNodeByTransform(t,e);break;case Actions.Resize:resizeNodeByTransform(e);break;default:scrollMove(t,e)}break;case EditModes.Link:case EditModes.Notes:scrollMove(t,e)}}function removeHighlights(t){const e=findHighlightTarget(t);e&&(e.classList.contains(HIGH_CLASS_1)?(e.classList.remove(HIGH_CLASS_1),hasEdits(!0)):e.classList.contains(HIGH_CLASS_2)?(e.classList.remove(HIGH_CLASS_2),hasEdits(!0)):e.classList.contains(HIGH_CLASS_3)?(e.classList.remove(HIGH_CLASS_3),hasEdits(!0)):e.classList.contains(HIGH_CLASS_4)&&(e.classList.remove(HIGH_CLASS_4),hasEdits(!0)))}function eraserMove(t){switch(Data.Action.Active||(document.body.classList.add("erasing"),Data.Action.Type=Actions.Erase,Data.Action.Active=!0,Data.IgnoreClick=!0),Data.Edit.Mode){case EditModes.Highlight:removeHighlights(t);break;case EditModes.Draw:t.classList.contains(DRAW_CLASS)&&(t.remove(),hasEdits(!0));break;case EditModes.Text:t.classList.contains(TEXT_CLASS)&&(t.remove(),hasEdits(!0));break;case EditModes.Image:t.classList.contains(IMAGE_CLASS)&&(t.remove(),hasEdits(!0));break;case EditModes.Link:case EditModes.Notes:}}function mouseMove(t){if(!Data.Pointer.Moved){if(Data.Pointer.X===t.clientX&&Data.Pointer.Y===t.clientY)return;Data.Pointer.Moved=!0}Data.Pointer.IgnoreMove||(t.buttons===Mouse.Buttons.Left?pointerMove(t.clientX,t.clientY,t.ctrlKey,t.shiftKey):t.buttons===Mouse.Buttons.Right&&Data.Edit.Mode!==EditModes.Off&&eraserMove(t.target))}function zoomTimer(){if(!Data.Zoom.Trigger)return;Data.Zoom.Trigger=!1;const t=parseFloat(Data.Svg.Node.style.width),e=parseFloat(Data.Svg.Node.style.height),a=Data.Svg.StartWidth*Data.Zoom.Level/100,o=Data.Svg.StartHeight*Data.Zoom.Level/100;Data.Svg.Node.style.width=a.toFixed(0)+"px",Data.Svg.Node.style.height=o.toFixed(0)+"px",Data.Svg.RatioX=a/Data.Svg.NativeWidth,Data.Svg.RatioY=o/Data.Svg.NativeHeight;const i=parseFloat(Data.Svg.Node.style.left),n=parseFloat(Data.Svg.Node.style.top),s=a/t,d=o/e,l=Data.Pointer.X-i,r=Data.Pointer.Y-n,c=l*s-l,g=r*d-r,m=n-g,u=i-c;Data.Svg.Node.style.top=m.toFixed(0)+"px",Data.Svg.Node.style.left=u.toFixed(0)+"px"}function applyZoomStep(t){Data.Zoom.Level<100?t/=4:100===Data.Zoom.Level&&t<0&&(t/=4),Data.Zoom.Level+=t,Data.Zoom.Level>1e3?Data.Zoom.Level=1e3:Data.Zoom.Level<10&&(Data.Zoom.Level=10),Data.Zoom.Trigger=!0}function wheelEvent(t){modalVisible?t.ctrlKey&&t.preventDefault():(t.preventDefault(),Data.Action.Active||Math.abs(t.deltaY)<.1||(Data.Pointer.X=t.clientX,Data.Pointer.Y=t.clientY,applyZoomStep(t.deltaY>0?-ZOOM_STEP_SIZE:ZOOM_STEP_SIZE)))}function zoomKey(t){Data.Pointer.X=window.innerWidth/2,Data.Pointer.Y=window.innerHeight/2,applyZoomStep(t)}function scrollStep(t,e){if(0!==t){const e=parseFloat(Data.Svg.Node.style.left),a=window.innerHeight*t,o=e-a;Data.Svg.Node.style.left=o.toFixed(0)+"px"}if(0!==e){const t=parseFloat(Data.Svg.Node.style.top),a=window.innerWidth*e,o=t-a;Data.Svg.Node.style.top=o.toFixed(0)+"px"}}function keyUpEvent(t){if(t.target===document.body&&!Data.Action.Active)switch(t.key){case"+":zoomKey(ZOOM_STEP_SIZE),t.preventDefault();break;case"-":zoomKey(-ZOOM_STEP_SIZE),t.preventDefault();break;case"=":resizeSvg(),t.preventDefault();break;case"ArrowUp":scrollStep(0,-SCROLL_STEP_SIZE),t.preventDefault();break;case"ArrowDown":scrollStep(0,SCROLL_STEP_SIZE),t.preventDefault();break;case"ArrowLeft":scrollStep(-SCROLL_STEP_SIZE,0),t.preventDefault();break;case"ArrowRight":scrollStep(SCROLL_STEP_SIZE,0),t.preventDefault();break;case"Enter":resetSvgPosition(),t.preventDefault()}}function windowResize(){resizeSvg(),setMenuPosition()}function pinchZoom(t,e,a,o){const i=Math.abs(t-a)+Math.abs(e-o),n=i-Data.PinchZoom.Distance;Math.abs(n)<.1||(Data.IgnoreClick=!0,Data.Pointer.X=t+(a-t)/2,Data.Pointer.Y=e+(o-e)/2,applyZoomStep(n),Data.PinchZoom.X1=t,Data.PinchZoom.Y1=e,Data.PinchZoom.X2=a,Data.PinchZoom.Y2=o,Data.PinchZoom.Distance=i)}function touchStart(t){0===Data.Pointer.TouchCount&&1===t.touches.length?(Data.IgnoreClick=!1,Data.Pointer.IgnoreMove=!0,pointerDown(t.touches[0].target,t.touches[0].clientX,t.touches[0].clientY,t.ctrlKey,t.shiftKey),Data.Pointer.TouchCount=1):Data.Pointer.TouchCount<2&&2===t.touches.length?(Data.IgnoreClick=!1,1===Data.Pointer.TouchCount&&pointerUp(t),Data.PinchZoom.X1=t.touches[0].clientX,Data.PinchZoom.Y1=t.touches[0].clientY,Data.PinchZoom.X2=t.touches[1].clientX,Data.PinchZoom.Y2=t.touches[1].clientY,Data.PinchZoom.Distance=Math.abs(Data.PinchZoom.X1-Data.PinchZoom.X2)+Math.abs(Data.PinchZoom.Y1-Data.PinchZoom.Y2),Data.Pointer.TouchCount=2):0!==Data.Pointer.TouchCount&&pointerUp(t)}function touchMove(t){t.preventDefault(),modalVisible||Data.Pointer.IgnoreMove||(1===t.touches.length&&1===Data.Pointer.TouchCount?pointerMove(t.touches[0].clientX,t.touches[0].clientY,t.ctrlKey,t.shiftKey):2===t.touches.length&&2===Data.Pointer.TouchCount&&pinchZoom(t.touches[0].clientX,t.touches[0].clientY,t.touches[1].clientX,t.touches[1].clientY))}function pointerUp(){Data.Action.Active&&(document.body.classList.remove("moving"),document.body.classList.remove("drawing"),document.body.classList.remove("erasing"),document.body.classList.remove("resizing"),document.body.classList.remove("rotating"),document.body.classList.remove("scrolling"),Data.Action.Active=!1),Data.Edit.Node&&Data.IgnoreClick&&Data.Edit.Node.classList.remove(SELECT_CLASS),Data.Pointer.TouchCount=0}function registerEventHandlers(){Data.Svg.Node.addEventListener("click",clickSvgEvent),window.addEventListener("auxclick",auxClickEvent),window.addEventListener("mousedown",mouseDown),window.addEventListener("mouseup",pointerUp),window.addEventListener("mousemove",mouseMove),window.addEventListener("touchstart",touchStart),window.addEventListener("touchend",pointerUp),window.addEventListener("touchmove",touchMove),window.addEventListener("keyup",keyUpEvent),window.addEventListener("wheel",wheelEvent,{passive:!1}),window.addEventListener("resize",windowResize),document.getElementById("file-selector").addEventListener("change",fileSelectorUploadEvent),setInterval(zoomTimer,100)}function flagClick(){const t=Data.Flags.indexOf(Data.Filename);-1!==t?Data.Flags.splice(t,1):Data.Flags.push(Data.Filename),localStorage.setItem(StoreName.Flags,JSON.stringify(Data.Flags)),updateMenuFlag()}function loadFlags(){const t=localStorage.getItem(StoreName.Flags);if(t){const e=JSON.parse(t);e&&(Data.Flags=e)}}function readFilterValuesfromSvg(){const t=Data.Svg.Node.style.filter;if(""===t)return!1;const e=t.indexOf("brightness"),a=t.indexOf("contrast"),o=t.indexOf("hue-rotate"),i=t.indexOf("saturate"),n=getStringBetween(t,e,"(",")"),s=getStringBetween(t,a,"(",")"),d=getStringBetween(t,o,"(","deg"),l=getStringBetween(t,i,"(",")");return n&&(Data.Controls.Brightness.value=10*n),s&&(Data.Controls.Contrast.value=10*s),d&&(Data.Controls.Hue.value=d),l&&(Data.Controls.Saturation.value=10*l),!0}function filterChange(){Data.Svg.Node.style.filter=getFiltersCss(Data.Controls.Brightness.value,Data.Controls.Contrast.value,Data.Controls.Hue.value,Data.Controls.Saturation.value)}function imageControlsResetClick(){Data.Controls.Brightness.value=Data.Controls.Brightness.defaultValue,Data.Controls.Contrast.value=Data.Controls.Contrast.defaultValue,Data.Controls.Hue.value=Data.Controls.Hue.defaultValue,Data.Controls.Saturation.value=Data.Controls.Saturation.defaultValue,filterChange()}function imageControlsSaveClick(){Settings.Filters.Brightness=Data.Controls.Brightness.value,Settings.Filters.Contrast=Data.Controls.Contrast.value,Settings.Filters.Hue=Data.Controls.Hue.value,Settings.Filters.Saturation=Data.Controls.Saturation.value,saveSettings(),Data.Controls.Open=!1,setControlsPosition()}function setControlsPosition(){const t=document.getElementById("menu"),e=document.getElementById("image-controls"),a=Data.Controls.Open?t.clientHeight:-e.clientHeight-2;e.style.top=a+"px",Data.Controls.Open?document.getElementById("menu-controls").classList.add("active"):document.getElementById("menu-controls").classList.remove("active")}function setupImageControls(){Data.Controls.Brightness=document.getElementById("brightness"),Data.Controls.Contrast=document.getElementById("contrast"),Data.Controls.Hue=document.getElementById("hue"),Data.Controls.Saturation=document.getElementById("saturation"),Data.Controls.Brightness.value=Settings.Filters.Brightness,Data.Controls.Contrast.value=Settings.Filters.Contrast,Data.Controls.Hue.value=Settings.Filters.Hue,Data.Controls.Saturation.value=Settings.Filters.Saturation,Data.Controls.Brightness.addEventListener("input",filterChange),Data.Controls.Contrast.addEventListener("input",filterChange),Data.Controls.Hue.addEventListener("input",filterChange),Data.Controls.Saturation.addEventListener("input",filterChange),document.getElementById("image-controls-reset").addEventListener("click",imageControlsResetClick),document.getElementById("image-controls-save").addEventListener("click",imageControlsSaveClick)}function setEditMenuPosition(){const t=document.getElementById("menu"),e=document.getElementById("edit-controls"),a=Data.Edit.Open?t.clientHeight:-e.clientHeight-2;e.style.top=a+"px",Data.Edit.Open?document.getElementById("menu-edit").classList.add("active"):document.getElementById("menu-edit").classList.remove("active")}function updateMenuFlag(){const t=document.getElementById("menu-flag");t&&(Data.Flags.includes(Data.Filename)?(t.title="Remove flag",t.className="flagged"):(t.title="Flag this diagram",t.className="unflagged"))}function updateDownloadButtonState(){const t=document.getElementById("menu-download-pdf"),e=document.getElementById("menu-download-png");navigator.onLine?(t&&(t.disabled=!1),e&&(e.disabled=!1)):(t&&(t.disabled=!0),e&&(e.disabled=!0))}function updateMenu(){const t=document.getElementById("menu-export-svg"),e=document.getElementById("menu-export-png"),a=document.getElementById("menu-download-pdf"),o=document.getElementById("menu-download-png");switch(Data.Edit.Mode===EditModes.Off?(Data.Svg.Node.classList.remove("edit-mode"),Data.IsSavedDiagram||(t&&(t.style.display="none"),e&&(e.style.display="none")),a&&(a.style.display="inline-block"),o&&(o.style.display="inline-block"),updateDownloadButtonState()):(Data.Svg.Node.classList.add("edit-mode"),Data.IsSavedDiagram||(t&&(t.style.display="inline-block"),e&&(e.style.display="inline-block")),a&&(a.style.display="none"),o&&(o.style.display="none")),Data.Svg.Node.classList.remove("draw-mode"),Data.Svg.Node.classList.remove("highlight-mode"),Data.Svg.Node.classList.remove("text-mode"),Data.Svg.Node.classList.remove("image-mode"),Data.Svg.Node.classList.remove("link-mode"),Data.Svg.Node.classList.remove("notes-mode"),document.getElementById("menu-highlight").classList.remove("active"),document.getElementById("menu-draw").classList.remove("active"),document.getElementById("menu-text").classList.remove("active"),document.getElementById("menu-image").classList.remove("active"),document.getElementById("menu-link").classList.remove("active"),document.getElementById("menu-notes").classList.remove("active"),Data.Edit.Mode){case EditModes.Draw:Data.Svg.Node.classList.add("draw-mode"),document.getElementById("menu-draw").classList.add("active");break;case EditModes.Highlight:Data.Svg.Node.classList.add("highlight-mode"),document.getElementById("menu-highlight").classList.add("active");break;case EditModes.Text:Data.Svg.Node.classList.add("text-mode"),document.getElementById("menu-text").classList.add("active");break;case EditModes.Image:Data.Svg.Node.classList.add("image-mode"),document.getElementById("menu-image").classList.add("active");break;case EditModes.Link:Data.Svg.Node.classList.add("link-mode"),document.getElementById("menu-link").classList.add("active");break;case EditModes.Notes:Data.Svg.Node.classList.add("notes-mode"),document.getElementById("menu-notes").classList.add("active")}}function setMenuPosition(){const t=document.getElementById("menu"),e=document.getElementById("menu-grip");if(Data.Menu.Open)e.title="Close menu",e.className="close",window.innerWidth<450?(t.style.left=0,t.style.borderLeft="none",t.style.borderRadius=0,t.style.width="100vw"):(t.style.removeProperty("left"),t.style.removeProperty("border-left"),t.style.removeProperty("border-radius"),t.style.removeProperty("width")),t.style.right=0;else{e.title="Open menu",e.className="open",window.innerWidth<450&&(t.style.removeProperty("left"),t.style.removeProperty("border-left"),t.style.removeProperty("border-radius"),t.style.removeProperty("width"));const a=t.clientWidth-e.clientWidth-8;t.style.right=-a+"px"}}function gripClick(){Data.Menu.Open=!Data.Menu.Open,setMenuPosition(),!Data.Menu.Open&&Data.Controls.Open&&(Data.Controls.Open=!1,setControlsPosition()),!Data.Menu.Open&&Data.Edit.Open&&(Data.Edit.Open=!1,setEditMenuPosition(),Data.Edit.LastMode=Data.Edit.Mode,Data.Edit.Mode=EditModes.Off,updateMenu())}function menuEditClick(){Data.Edit.Open=!Data.Edit.Open,setEditMenuPosition(),Data.Edit.Open?Data.Edit.LastMode&&(Data.Edit.Mode=Data.Edit.LastMode):(Data.Edit.LastMode=Data.Edit.Mode,Data.Edit.Mode=EditModes.Off),updateMenu(),Data.Edit.Open&&Data.Controls.Open&&(Data.Controls.Open=!1,setControlsPosition())}function menuHighlightClick(){Data.Edit.Mode=EditModes.Highlight,updateMenu()}function menuDrawClick(){Data.Edit.Mode=EditModes.Draw,updateMenu()}function menuTextClick(){Data.Edit.Mode=EditModes.Text,updateMenu()}function menuImageClick(){Data.Edit.Mode=EditModes.Image,updateMenu()}function menuLinkClick(){Data.Edit.Mode=EditModes.Link,updateMenu()}function menuTooltipClick(){Data.Edit.Mode=EditModes.Notes,updateMenu()}function menuControlsClick(){Data.Controls.Open=!Data.Controls.Open,setControlsPosition(),Data.Controls.Open&&Data.Edit.Open&&(Data.Edit.Open=!1,setEditMenuPosition(),Data.Edit.LastMode=Data.Edit.Mode,Data.Edit.Mode=EditModes.Off,updateMenu())}function saveSvg(t,e){const a=getSvgXml(),o={Title:t,SvgXml:a},i=JSON.stringify(o);localStorage.setItem(e,i),hasEdits(!1)}function saveOK(t){let e=getModalInputText();if(e&&(e=e.trim()),e){const a=Date.now().toString();saveSvg(e,a),t?t():window.location.href=`/viewsvg.htm#*${a}`}}function overwriteYes(t){saveSvg(Data.SavedDiagramTitle,Data.Filename),t&&t()}function overwriteNo(t,e){showModalDialog("Save diagram as",!0,Data.SavedDiagramTitle,"OK",()=>saveOK(t),void 0,void 0,"Cancel",e)}function requestSave(t){if(Data.IsSavedDiagram)showModalDialog(`Overwrite existing diagram "${Data.SavedDiagramTitle}"?`,!1,void 0,"Yes",()=>overwriteYes(t),"No",()=>overwriteNo(t),"Cancel",void 0);else{const e=document.getElementById("diagram-name"),a=e?e.textContent:decodeURIComponent(Data.Filename);showModalDialog("Save diagram as",!0,a,"OK",()=>saveOK(t),void 0,void 0,"Cancel",void 0)}}function menuSaveClick(){requestSave()}function exportSvgClick(){const t=Data.IsSavedDiagram?Data.SavedDiagramTitle:decodeURIComponent(Data.Filename),e=getSvgXml();exportSvg(t+".svg",e)}function exportPngClick(){const t=Data.IsSavedDiagram?Data.SavedDiagramTitle:decodeURIComponent(Data.Filename),e=getSvgXml(),a=window.getComputedStyle(document.body).backgroundColor;exportPng(t+".png",e,a)}function backClick(){Data.Edit.HasEdits?showModalDialog("Would you like to save your changes before leaving the page?",!1,void 0,"Yes",()=>requestSave(backOrHome),"No",backOrHome,"Cancel",void 0):backOrHome()}function setupMenu(){document.getElementById("menu-grip").addEventListener("click",gripClick),document.getElementById("menu-back").addEventListener("click",backClick),document.getElementById("menu-edit").addEventListener("click",menuEditClick),document.getElementById("menu-highlight").addEventListener("click",menuHighlightClick),document.getElementById("menu-draw").addEventListener("click",menuDrawClick),document.getElementById("menu-text").addEventListener("click",menuTextClick),document.getElementById("menu-image").addEventListener("click",menuImageClick),document.getElementById("menu-link").addEventListener("click",menuLinkClick),document.getElementById("menu-notes").addEventListener("click",menuTooltipClick),
document.getElementById("menu-controls").addEventListener("click",menuControlsClick),document.getElementById("menu-save").addEventListener("click",menuSaveClick),document.getElementById("menu-export-svg").addEventListener("click",exportSvgClick),document.getElementById("menu-export-png").addEventListener("click",exportPngClick);const t=document.getElementById("menu-flag");t&&t.addEventListener("click",flagClick);const e=document.getElementById("menu-download-pdf");e&&e.addEventListener("click",()=>document.getElementById("download-pdf").click());const a=document.getElementById("menu-download-png");a&&a.addEventListener("click",()=>document.getElementById("download-png").click()),Data.Menu.Open="Open"===Settings.Menu}function legacyRedirect(){let t=window.location.href.indexOf("#");if(-1===t&&(t=window.location.href.indexOf("=")),-1===t||t===window.location.href.length-1)return!1;if("*"===window.location.href[t+1])return!1;const e=window.location.origin+"/"+window.location.href.substring(t+1)+".htm";return location.replace(e),!0}function loadSavedDiagram(){if(!window.location.hash||window.location.hash.length<=2)return showModalDialog("Missing saved diagram details",!1,void 0,"OK",Data.IsComparing?void 0:backOrHome),!1;Data.IsComparing?Data.Filename=window.location.hash.slice(2,-8):Data.Filename=window.location.hash.substring(2);const t=localStorage.getItem(Data.Filename);if(!t)return showModalDialog("Failed to locate saved diagram",!1,void 0,"OK",Data.IsComparing?void 0:backOrHome),!1;const e=JSON.parse(t);if(!e||!e.SvgXml)return showModalDialog("Failed to process saved diagram data",!1,void 0,"OK",Data.IsComparing?void 0:backOrHome),!1;Data.SavedDiagramTitle=e.Title,document.title=`Saved Diagram: ${e.Title} | M365 Maps`;const a=e.SvgXml.replace(/<!--.*-->/i,"").replace(/<\?xml.*\?>/i,"").replace(/<!doctype.*>/i,"").replace(/^[\n\r]+/,"");return Data.Svg.Node=createElementFromHtml(a),document.body.appendChild(Data.Svg.Node),!0}function DOMContentLoaded(){setupModal(),Data.IsComparing?(document.body.style.overflow="hidden",document.getElementById("menu").style.display="none",document.getElementById("edit-controls").style.display="none",document.getElementById("image-controls").style.display="none"):(setupMenu(),window.addEventListener("offline",updateDownloadButtonState),window.addEventListener("online",updateDownloadButtonState),Data.IsSavedDiagram||(loadFlags(),Data.Filename=window.location.pathname.slice(1,-4))),setupImageControls()}function pageLoad(){if(Data.IsSavedDiagram){const t=loadSavedDiagram();if(!t)return}else Data.Svg.Node=document.getElementsByTagName("svg").item(0);Data.Svg.NativeWidth=parseFloat(Data.Svg.Node.getAttribute("width")),Data.Svg.NativeHeight=parseFloat(Data.Svg.Node.getAttribute("height")),resizeSvg(),injectHighlightStyles();const t=readFilterValuesfromSvg();t||filterChange(),Data.IsComparing||(updateMenu(),updateMenuFlag(),setMenuPosition(),setControlsPosition()),registerEventHandlers(),Data.Svg.Node.style.display="inline"}const SVG_NAMESPACE="http://www.w3.org/2000/svg",STYLE_ID="m365MapsHighlights",SELECT_CLASS="m365maps-select",DRAW_CLASS="m365maps-draw",TEXT_CLASS="m365maps-text",IMAGE_CLASS="m365maps-image",HIGH_CLASS_1="highlight1",HIGH_CLASS_2="highlight2",HIGH_CLASS_3="highlight3",HIGH_CLASS_4="highlight4",SCROLL_STEP_SIZE=.05,ZOOM_STEP_SIZE=20,IMAGE_GALLERY=[{label:"Tick",value:"/media/sprites.svg#tick(32x32)"},{label:"Cross",value:"/media/sprites.svg#cross(32x32)"},{label:"Star",value:"/media/sprites.svg#star(32x32)"},{label:"Priority: High",value:"/media/sprites.svg#label-priority-high(96x15)"},{label:"Priority: Medium",value:"/media/sprites.svg#label-priority-medium(96x15)"},{label:"Priority: Low",value:"/media/sprites.svg#label-priority-low(96x15)"},{label:"Priority: Must Have",value:"/media/sprites.svg#label-mscw-m(32x32)"},{label:"Priority: Should Have",value:"/media/sprites.svg#label-mscw-s(32x32)"},{label:"Priority: Could Have",value:"/media/sprites.svg#label-mscw-c(32x32)"},{label:"Priority: Won't Have",value:"/media/sprites.svg#label-mscw-w(32x32)"},{label:"Label: Will",value:"/media/sprites.svg#label-will(96x15)"},{label:"Label: In progress",value:"/media/sprites.svg#label-in-progress(96x15)"},{label:"Label: Testing",value:"/media/sprites.svg#label-testing(96x15)"},{label:"Label: Purchasing",value:"/media/sprites.svg#label-purchasing(96x15)"},{label:"Label: Purchased",value:"/media/sprites.svg#label-purchased(96x15)"},{label:"Label: On hold",value:"/media/sprites.svg#label-on-hold(96x15)"},{label:"Label: Not yet",value:"/media/sprites.svg#label-not-yet(96x15)"},{label:"Label: Done",value:"/media/sprites.svg#label-done(96x15)"},{label:"Completion: 0%",value:"/media/sprites.svg#percent-0(32x32)"},{label:"Completion: 25%",value:"/media/sprites.svg#percent-1(32x32)"},{label:"Completion: 50%",value:"/media/sprites.svg#percent-2(32x32)"},{label:"Completion: 75%",value:"/media/sprites.svg#percent-3(32x32)"},{label:"Completion: 100%",value:"/media/sprites.svg#percent-4(32x32)"},{label:"Phase: 1",value:"/media/sprites.svg#label-phase-1(96x15)"},{label:"Phase: 2",value:"/media/sprites.svg#label-phase-2(96x15)"},{label:"Phase: 3",value:"/media/sprites.svg#label-phase-3(96x15)"},{label:"Status: Green",value:"/media/sprites.svg#status-green(32x32)"},{label:"Status: Yellow",value:"/media/sprites.svg#status-yellow(32x32)"},{label:"Status: Red",value:"/media/sprites.svg#status-red(32x32)"},{label:"Traffic Light: Green",value:"/media/sprites.svg#light-green(30x80)"},{label:"Traffic Light: Yellow",value:"/media/sprites.svg#light-yellow(30x80)"},{label:"Traffic Light: Red",value:"/media/sprites.svg#light-red(30x80)"},{label:"Arrow: Up",value:"/media/sprites.svg#arrow-up(32x32)"},{label:"Arrow: Down",value:"/media/sprites.svg#arrow-down(32x32)"},{label:"Arrow: Left",value:"/media/sprites.svg#arrow-left(32x32)"},{label:"Arrow: Right",value:"/media/sprites.svg#arrow-right(32x32)"}],Colours=["Red","Orange","Yellow","Lime","Green","Navy","Blue","Aqua","Fuchsia","Purple","Black","Gray","White"],EditModes={Off:0,Highlight:1,Draw:2,Text:3,Image:4,Link:5,Notes:6},Actions={None:0,Add:1,Move:2,Erase:3,Resize:4,Rotate:5,Scroll:6},Data={Action:{Active:!1,Type:Actions.None},Controls:{Brightness:void 0,Contrast:void 0,Hue:void 0,Open:!1,Saturation:void 0},Edit:{HasEdits:!1,Open:!1,Mode:EditModes.Off,LastMode:EditModes.Highlight,Node:void 0,Transform:{Rotate:0,Scale:1,Translate:{X:0,Y:0},StartScale:1}},Filename:"",Flags:[],IgnoreClick:!1,IsComparing:!1,IsSavedDiagram:!1,Menu:{Open:!1},PinchZoom:{Distance:0,X1:0,Y1:0,X2:0,Y2:0},Pointer:{IgnoreMove:!0,Moved:!1,TouchCount:0,X:0,Y:0},SavedDiagramTitle:"untitled",Scroll:{StartLeft:0,StartTop:0},Svg:{Node:void 0,StartWidth:0,StartHeight:0,NativeWidth:0,NativeHeight:0,RatioX:0,RatioY:0},Zoom:{Level:100,Trigger:!1}};Data.IsComparing=window.location.hash.endsWith("/compare"),Data.IsSavedDiagram="/viewsvg.htm"===window.location.pathname;let redirecting=!1;Data.IsSavedDiagram&&(redirecting=legacyRedirect()),redirecting||(document.addEventListener("DOMContentLoaded",DOMContentLoaded),window.addEventListener("load",pageLoad));